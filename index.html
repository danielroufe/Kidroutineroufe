<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
<title>KidRoutine Deluxe + Voice ğŸŒŸ</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#10b981">
<style>
:root{--bg:#f0fff7;--card:#fff;--text:#111;--muted:#047857;--brand:#10b981;--brand2:#059669;--accent:#34d399}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Heebo,Arial;background:radial-gradient(1000px 800px at 100% -10%,#bbf7d0 0,#f0fff7 40%),#f0fff7;color:var(--text)}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;position:sticky;top:0;background:#ffffffd0;backdrop-filter:saturate(180%) blur(8px);border-bottom:2px solid #dcfce7}
.brand{display:flex;align-items:center;gap:8px;font-weight:900;font-size:18px}
.badge{border:2px dashed #86efac;border-radius:999px;padding:6px 12px;font-size:12px;color:#065f46;background:#ecfdf5}
main{max-width:560px;margin:0 auto;padding:12px}
.card{background:var(--card);border:2px solid #dcfce7;border-radius:22px;padding:12px;margin:14px 0;box-shadow:0 8px 0 #86efac}
.title{display:flex;align-items:center;gap:8px;font-weight:900;font-size:22px}
.muted{color:var(--muted);font-size:13px}
.tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;background:#d1fae5;border-radius:16px;padding:6px}
.tabs button{background:#a7f3d0;border:2px solid #6ee7b7;border-radius:12px;padding:10px;font-weight:900;cursor:pointer}
.tabs .active{background:#fff;border-color:#34d399;box-shadow:0 4px 0 #6ee7b7}
.progress{height:14px;background:#dcfce7;border-radius:999px;overflow:hidden;border:2px solid #6ee7b7}
.progress>div{height:100%;background:linear-gradient(90deg,#60a5fa,#10b981);width:0%}
.grid{display:grid;gap:10px}
.task{display:flex;align-items:center;gap:12px;padding:12px;border:2px solid #bbf7d0;border-radius:16px;background:#fff;box-shadow:0 4px 0 #86efac;transition:transform .05s}
.task:active{transform:translateY(1px)}
.icon{width:60px;height:60px;display:grid;place-items:center;background:#ecfeff;border:2px solid #bae6fd;border-radius:14px;font-size:36px}
.name{font-size:18px;font-weight:900}
.mini{font-size:12px;color:#0f766e}
.toggle{width:64px;height:36px;border-radius:999px;background:#fde68a;border:2px solid #fbbf24;position:relative;cursor:pointer}
.toggle::after{content:"";position:absolute;inset:3px;width:28px;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.15);transition:transform .2s}
.toggle.on{background:#86efac;border-color:#34d399}
.toggle.on::after{transform:translateX(24px)}
.btn{appearance:none;border:none;border-radius:12px;padding:10px 12px;background:var(--brand);color:#fff;font-weight:900;cursor:pointer;box-shadow:0 4px 0 var(--brand2)}
.btn.ghost{background:#f0fdf4;color:#065f46;border:2px solid #86efac;box-shadow:none}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{background:#ecfeff;border:2px solid #bae6fd;border-radius:999px;padding:6px 10px;font-weight:900}
/* sticker animation */
.sticker{position:absolute;transform:rotate(-12deg) scale(0.5);opacity:0;animation:stick 0.6s ease-out forwards;transform-origin:bottom right}
@keyframes stick{0%{opacity:0;transform:rotate(-12deg) scale(0.5) translate(20px,-20px)}60%{opacity:1;transform:rotate(8deg) scale(1.05)}100%{opacity:1;transform:rotate(0) scale(1)}}
/* reward shelf */
.shelf{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.slot{height:72px;border:2px dashed #a7f3d0;border-radius:12px;display:grid;place-items:center;background:#fff}
.slot.filled{border-style:solid;background:#f0fdf4}
/* Voice Panel */
.voice-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.voice-row select,.voice-row input[type=range]{padding:8px;border:2px solid #bbf7d0;border-radius:12px}
.small{font-size:12px;color:#64748b}
</style>
</head>
<body>
<header>
  <div class="brand">KidRoutine Deluxe + Voice ğŸŒŸ</div>
  <div style="display:flex;align-items:center;gap:8px">
    <button id="installBtn" class="btn" style="display:none">×”×ª×§× ×”</button>
    <span id="status" class="badge">×•×•×‘</span>
  </div>
</header>
<main>
  <section class="card">
    <div class="title">×©×œ×•× <span id="kidNameLabel">×’×™×‘×•×¨/×”</span>! ğŸŒˆ</div>
    <div class="muted" id="subtitle">×‘×•×/×™ × ×ª×§×ª×§ ××©×™××•×ª ×‘×›×™×£</div>
    <div class="progress" style="margin-top:8px"><div id="progressBar" style="width:0%"></div></div>
    <div class="muted" style="margin-top:6px">×”×ª×§×“××•×ª: <span id="progressText">0%</span></div>
  </section>

  <div class="tabs card">
    <button id="tabMorning" class="active">×‘×•×§×¨ ğŸŒ</button>
    <button id="tabEvening">×¢×¨×‘ ğŸŒ™</button>
    <button id="tabAchieve">×—×™×–×•×§×™× â­</button>
  </div>

  <section id="list" class="card grid"></section>

  <section class="card">
    <div class="title">×¤×¨×¡×™× ×•××“×‘×§×•×ª</div>
    <div class="muted">×¦×•×‘×¨×™× ××˜×‘×¢×•×ª â†’ ×§×•× ×™× ××“×‘×§×•×ª ×œ××“×£ ×”×”×™×©×’×™×</div>
    <div class="chips" id="wallet"></div>
    <div style="display:flex;gap:8px;margin:8px 0">
      <button class="btn" id="buySmile">×§× ×” ××“×‘×§×ª ğŸ˜€ (5)</button>
      <button class="btn" id="buyStar">×§× ×” ××“×‘×§×ª â­ (5)</button>
      <button class="btn" id="buyTrophy">×§× ×” ×’×‘×™×¢ ğŸ† (10)</button>
    </div>
    <div class="shelf" id="shelf"></div>
  </section>

  <section class="card">
    <div class="title">×”×’×“×¨×•×ª ×œ×”×•×¨×”</div>
    <div class="row" style="display:flex;align-items:center;gap:8px;margin-top:8px">
      <label>×©× ×”×™×œ×“/×”:</label>
      <input id="kidName" placeholder="×’×™×‘×•×¨/×”" style="max-width:220px;padding:10px;border:2px solid #bbf7d0;border-radius:12px">
    </div>
    <hr style="margin:10px 0;border:none;border-top:1px dashed #e2e8f0">
    <div class="voice-row">
      <label style="font-weight:900">×§×¨×™×™× ×•×ª:</label>
      <input type="checkbox" id="voiceOn">
      <select id="voiceSelect"></select>
      <label class="small">××”×™×¨×•×ª</label><input type="range" id="voiceRate" min="0.6" max="1.4" step="0.05" value="1">
      <label class="small">×’×•×‘×”</label><input type="range" id="voicePitch" min="0.6" max="1.4" step="0.05" value="1">
      <button class="btn ghost" id="testVoice">×‘×“×™×§×ª ×§×•×œ</button>
    </div>
    <div class="small">* ×”×§×¨×™×™× ×•×ª ××©×ª××©×ª ×‘Ö¾Web Speech ×©×œ ×”×“×¤×“×¤×Ÿ. ×‘×¡×¤××¨×™/×›×¨×•× ×™×© ×œ×‘×—×•×¨ ×§×•×œ ×¢×‘×¨×™ ××ª××™× ××”×¨×©×™××”.</div>
  </section>
</main>

<script>
// ---------- storage ----------
const LS=(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } };
const SET=(k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} };

// ---------- state ----------
let tab=LS('tab','morning');
let nameVal=LS('kidName','×’×™×‘×•×¨/×”');
let morning=LS('morningTasks',[
  {id:crypto.randomUUID(),title:"×œ×”×ª×¢×•×¨×¨ ×‘×–××Ÿ",minutes:2},
  {id:crypto.randomUUID(),title:"×œ×œ×›×ª ×œ×©×™×¨×•×ª×™×",minutes:3},
  {id:crypto.randomUUID(),title:"×œ×¦×—×¦×— ×©×™× ×™×™× ×•×œ×©×˜×•×£ ×¤× ×™×",minutes:3},
  {id:crypto.randomUUID(),title:"×œ×”×ª×œ×‘×© ×œ×‘×“",minutes:5},
  {id:crypto.randomUUID(),title:"×œ××›×•×œ ××¨×•×—×ª ×‘×•×§×¨",minutes:10},
  {id:crypto.randomUUID(),title:"×œ×§×—×ª ×ª×™×§ ×•×‘×§×‘×•×§ ××™×",minutes:1},
]);
let evening=LS('eveningTasks',[
  {id:crypto.randomUUID(),title:"×œ××¡×•×£ ×¦×¢×¦×•×¢×™×",minutes:5},
  {id:crypto.randomUUID(),title:"×œ×”×›×™×Ÿ ×ª×™×§ ×œ×‘×™×ª ×”×¡×¤×¨",minutes:4},
  {id:crypto.randomUUID(),title:"×©×™×¢×•×¨×™ ×‘×™×ª",minutes:20},
  {id:crypto.randomUUID(),title:"×œ×”×›×™×Ÿ ×‘×’×“×™× ×œ××—×¨",minutes:3},
  {id:crypto.randomUUID(),title:"×œ×¦×—×¦×— ×©×™× ×™×™×",minutes:3},
  {id:crypto.randomUUID(),title:"×¡×™×¤×•×¨ ×œ×¤× ×™ ×”×©×™× ×”",minutes:10},
]);
let motives=LS('motives',[
  {id:crypto.randomUUID(),title:"×”×›×™×¨ ×—×‘×¨ ×—×“×©"},
  {id:crypto.randomUUID(),title:"×©×™×—×§ ×™×¤×” ×¢× ××—×¨×™×"},
  {id:crypto.randomUUID(),title:"×¢×©×” ×¤×™×¤×™/×§×§×™ ×‘×‘×™×ª ×”×¡×¤×¨"},
  {id:crypto.randomUUID(),title:"××™×œ× ××™× ×œ×‘×“"},
  {id:crypto.randomUUID(),title:"×¢×–×¨ ×œ××•×¨×”"},
]);
let today=new Date().toDateString();
let done=LS('doneToday',{date:today,morning:{},evening:{},motives:{}});
if(done.date!==today){ done={date:today,morning:{},evening:{},motives:{}}; SET('doneToday',done); }
let coins=LS('coins',0);
let stars=LS('stars',0);
let shelf=LS('shelf',Array(8).fill(null));

// Voice prefs
let voiceOn = LS('voiceOn', true);
let voiceName = LS('voiceName', '');
let voiceRate = LS('voiceRate', 1);
let voicePitch = LS('voicePitch', 1);

const el=s=>document.querySelector(s);
const mk=t=>document.createElement(t);
const save=()=>{ SET('tab',tab); SET('kidName',nameVal); SET('morningTasks',morning); SET('eveningTasks',evening); SET('motives',motives); SET('doneToday',done); SET('coins',coins); SET('stars',stars); SET('shelf',shelf); SET('voiceOn', voiceOn); SET('voiceName', voiceName); SET('voiceRate', voiceRate); SET('voicePitch', voicePitch); };

// ---------- voice (Web Speech API) ----------
let voices=[];
function loadVoices(){
  voices = speechSynthesis.getVoices().filter(v=>/he|Hebrew/i.test(v.lang) || /Hebrew/i.test(v.name));
  const sel = el('#voiceSelect');
  sel.innerHTML='';
  if(voices.length===0){
    // fallback: list all voices
    voices = speechSynthesis.getVoices();
  }
  voices.forEach(v=>{
    const opt = mk('option'); opt.value=v.name; opt.textContent = `${v.name} (${v.lang})`;
    if(v.name===voiceName) opt.selected = true;
    sel.appendChild(opt);
  });
  if(!voiceName && voices[0]) voiceName = voices[0].name;
}
if('speechSynthesis' in window){
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}

function say(text){
  if(!voiceOn || !('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  const v = voices.find(x=>x.name===voiceName) || voices.find(x=>/he|Hebrew/i.test(x.lang)) || voices[0];
  if(v) u.voice = v;
  u.lang = (v && v.lang) || 'he-IL';
  u.rate = parseFloat(voiceRate)||1;
  u.pitch = parseFloat(voicePitch)||1;
  try{ speechSynthesis.cancel(); speechSynthesis.speak(u); }catch{}
}

const PHRASES = {
  startMorning: ()=>`×‘×•×§×¨ ×˜×•×‘ ${nameVal}! ××ª×—×™×œ×™× ××©×™××•×ª ×‘×©××—×”.`,
  startEvening: ()=>`×¢×¨×‘ × ×¢×™× ${nameVal}. ××¡×™×™××™× ×‘× ×—×ª ×•××ª××¨×’× ×™× ×œ×©×™× ×”.`,
  doneTask: (t)=>`×›×œ ×”×›×‘×•×“! ×¡×™×™××ª: ${t}`,
  buy: (s)=>`×™×©! ×§× ×™×ª ××“×‘×§×” ${s}`,
  finishedRoutine: (k)=> k==='morning' ? '×›×œ ×”××©×™××•×ª ×©×œ ×”×‘×•×§×¨ ×”×•×©×œ××•! ×›×•×›×‘ × ×•×¡×£!' : '×›×œ ××©×™××•×ª ×”×¢×¨×‘ ×”×•×©×œ××•! ×›×•×›×‘ × ×•×¡×£!'
};

// ---------- UI helpers ----------
function emojiFor(title){
  const m = {
    "×œ×”×ª×¢×•×¨×¨ ×‘×–××Ÿ":"â°","×œ×œ×›×ª ×œ×©×™×¨×•×ª×™×":"ğŸš½","×œ×¦×—×¦×— ×©×™× ×™×™× ×•×œ×©×˜×•×£ ×¤× ×™×":"ğŸª¥","×œ×¦×—×¦×— ×©×™× ×™×™×":"ğŸª¥",
    "×œ×”×ª×œ×‘×© ×œ×‘×“":"ğŸ‘•","×œ××›×•×œ ××¨×•×—×ª ×‘×•×§×¨":"ğŸ¥£","×œ×§×—×ª ×ª×™×§ ×•×‘×§×‘×•×§ ××™×":"ğŸ’","×œ××¡×•×£ ×¦×¢×¦×•×¢×™×":"ğŸ§¸",
    "×œ×”×›×™×Ÿ ×ª×™×§ ×œ×‘×™×ª ×”×¡×¤×¨":"ğŸ’","×©×™×¢×•×¨×™ ×‘×™×ª":"âœï¸","×œ×”×›×™×Ÿ ×‘×’×“×™× ×œ××—×¨":"ğŸ‘š","×¡×™×¤×•×¨ ×œ×¤× ×™ ×”×©×™× ×”":"ğŸ“–",
    "×”×›×™×¨ ×—×‘×¨ ×—×“×©":"ğŸ¤","×©×™×—×§ ×™×¤×” ×¢× ××—×¨×™×":"âš½","×¢×©×” ×¤×™×¤×™/×§×§×™ ×‘×‘×™×ª ×”×¡×¤×¨":"ğŸŒŸ","××™×œ× ××™× ×œ×‘×“":"ğŸš°","×¢×–×¨ ×œ××•×¨×”":"ğŸ"
  };
  return m[title] || 'â­';
}
function progressFor(kind){ const list=(kind==='morning'?morning:evening); const map=done[kind]; const total=list.length||1; const cnt=list.filter(t=>map[t.id]).length; return Math.round(100*cnt/total); }
function renderHeader(){ el('#kidNameLabel').textContent=nameVal; const p=tab==='morning'?progressFor('morning'):tab==='evening'?progressFor('evening'):0; el('#progressBar').style.width=p+'%'; el('#progressText').textContent=p+'%'; el('#subtitle').textContent=tab==='morning'?'×‘×•×/×™ × ×ª×§×ª×§ ××©×™××•×ª ×‘×›×™×£':(tab==='evening'?'× ×¡×™×™× ×‘× ×¢×™××™× ×•× ×œ×š ×œ×™×©×•×Ÿ':'×¡××Ÿ/×™ ×”×¦×œ×—×•×ª ×™×•××™×•××™×•×ª ×‘×‘×™×ª ×”×¡×¤×¨ ×•×‘×—×™×™×'); }
function stickerAt(target, text="â­"){ const s=mk('div'); s.className='sticker'; s.textContent=text; const r=target.getBoundingClientRect(); s.style.left=(r.right-16)+'px'; s.style.top=(r.top-8 + window.scrollY)+'px'; document.body.appendChild(s); setTimeout(()=>s.remove(),800); }
function makeRow(t, checked, onToggle){ const row=mk('div'); row.className='task'; const icon=mk('div'); icon.className='icon'; icon.textContent=emojiFor(t.title); const text=mk('div'); text.innerHTML='<div class="name">'+t.title+'</div>'+(t.minutes?'<div class="mini">×˜×™×™××¨ ××•×¦×¢: '+t.minutes+' ×“×§×³</div>':''); const tog=mk('div'); tog.className='toggle'+(checked?' on':''); tog.onclick=(e)=>{ e.stopPropagation(); onToggle(e.currentTarget); }; row.onclick=(e)=>{ onToggle(tog); }; row.append(icon,text,tog); return row; }
function renderList(){ const box=el('#list'); box.innerHTML=''; if(tab==='morning'||tab==='evening'){ const list=(tab==='morning'?morning:evening); const map=done[tab]; list.forEach(t=>{ const row=makeRow(t, !!map[t.id], (anchor)=>{ const was=!!map[t.id]; map[t.id]=!was; anchor.classList.toggle('on', !!map[t.id]); if(!was){ coins+=1; stickerAt(anchor,'ğŸ˜€'); say(PHRASES.doneTask(t.title)); } save(); renderHeader(); renderWallet(); if(progressFor(tab)===100 && !was){ stars+=1; say(PHRASES.finishedRoutine(tab)); save(); renderWallet(); } }); box.appendChild(row); }); } else { motives.forEach(m=>{ const row=makeRow({title:m.title}, !!done.motives[m.id], (anchor)=>{ const was=!!done.motives[m.id]; done.motives[m.id]=!was; anchor.classList.toggle('on', !!done.motives[m.id]); if(!was){ coins+=2; stickerAt(anchor,'â­'); say(PHRASES.doneTask(m.title)); } save(); renderHeader(); renderWallet(); }); box.appendChild(row); }); } }
function renderTabs(){ document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active')); if(tab==='morning') el('#tabMorning').classList.add('active'); else if(tab==='evening') el('#tabEvening').classList.add('active'); else el('#tabAchieve').classList.add('active'); }
function renderWallet(){ const w=el('#wallet'); w.innerHTML=''; const a=mk('span'); a.className='chip'; a.textContent='××˜×‘×¢×•×ª: '+coins; const b=mk('span'); b.className='chip'; b.textContent='×›×•×›×‘×™×: '+stars; w.append(a,b); }
function renderShelf(){ const s=el('#shelf'); s.innerHTML=''; shelf.forEach((val,i)=>{ const slot=mk('div'); slot.className='slot'+(val?' filled':''); slot.textContent=val||'â€”'; s.appendChild(slot); }); }

function buySticker(symbol, cost){ if(coins<cost){ say('×¦×¨×™×š ×¢×•×“ ××˜×‘×¢×•×ª'); alert('×¦×¨×™×š ×¢×•×“ ××˜×‘×¢×•×ª!'); return; } const idx=shelf.findIndex(x=>!x); if(idx===-1){ say('×”××“×£ ××œ×'); alert('×”××“×£ ××œ×!'); return; } coins-=cost; shelf[idx]=symbol; save(); renderWallet(); renderShelf(); say(PHRASES.buy(symbol)); }

function bindEvents(){ el('#tabMorning').onclick=()=>{ tab='morning'; save(); renderTabs(); renderList(); renderHeader(); say(PHRASES.startMorning()); }; el('#tabEvening').onclick=()=>{ tab='evening'; save(); renderTabs(); renderList(); renderHeader(); say(PHRASES.startEvening()); }; el('#tabAchieve').onclick=()=>{ tab='achieve'; save(); renderTabs(); renderList(); renderHeader(); }; el('#kidName').oninput=(e)=>{ nameVal=e.target.value; save(); renderHeader(); }; el('#buySmile').onclick=()=>buySticker('ğŸ˜€',5); el('#buyStar').onclick=()=>buySticker('â­',5); el('#buyTrophy').onclick=()=>buySticker('ğŸ†',10); // voice controls
  const vOn=el('#voiceOn'); const vSel=el('#voiceSelect'); const vRate=el('#voiceRate'); const vPitch=el('#voicePitch'); vOn.checked = !!voiceOn; vRate.value = voiceRate; vPitch.value = voicePitch; vSel.addEventListener('change', ()=>{ voiceName=vSel.value; save(); }); vOn.addEventListener('change', ()=>{ voiceOn=vOn.checked; save(); }); vRate.addEventListener('input', ()=>{ voiceRate=vRate.value; save(); }); vPitch.addEventListener('input', ()=>{ voicePitch=vPitch.value; save(); }); el('#testVoice').onclick=()=> say(`×©×œ×•× ${nameVal}! ×–×”×• ×§×•×œ ×”×“×•×’××”. ×›×œ ×”×›×‘×•×“ ×¢×œ ×”×¢×‘×•×“×” ×”× ×”×“×¨×ª!`); }

function init(){ document.title='KidRoutine Deluxe + Voice ğŸŒŸ'; el('#kidName').value=nameVal; renderTabs(); renderHeader(); renderList(); renderWallet(); renderShelf(); bindEvents(); if(tab==='morning'){ say(PHRASES.startMorning()); } }

// PWA install
let deferred=null; const installBtn=document.querySelector('#installBtn');
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferred=e; installBtn.style.display='inline-block'; });
installBtn.onclick = async ()=>{ if(!deferred) return; deferred.prompt(); const choice = await deferred.userChoice; if(choice.outcome==='accepted'){ document.querySelector('#status').textContent='××•×ª×§×Ÿ'; installBtn.style.display='none'; } };
window.addEventListener('appinstalled', ()=>{ document.querySelector('#status').textContent='××•×ª×§×Ÿ'; installBtn.style.display='none'; });
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(()=>{}) ); }

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
